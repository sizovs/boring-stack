version: 3

dotenv:
  - .env.devops

env:
  NODE_ENV: development
  COOKIE_SECRET: unsecure

tasks:
  terraform:
    cmds:
      - terraform -chdir=deploy {{.CLI_ARGS}}
  test:
    env:
      DB_LOCATION: ":memory:"
    cmds:
      - npm test
      - npx playwright test
  dev:
    env:
      PORT: 3000
      DB_LOCATION: ./modules/database/db.sqlite3
    cmds:
      - npm install
      - npm run dev
  db:pull:
    env:
      DB_LOCATION: ./modules/database/db.sqlite3
    cmds:
      - rm -rf ./backup
      - scp -r devops@$SERVER_IP:/mnt/backup ./backup
      - litestream restore -o $DB_LOCATION ./backup
  deploy:
    silent: true
    cmds:
      - echo Will deploy to $SERVER_IP
      - rsync -a --exclude '.env.devops' --exclude 'node_modules' --exclude 'deploy' --exclude 'db.sqlite3*' ./ devops@$SERVER_IP:/home/devops/latest
      - ssh devops@$SERVER_IP "bash -s" < ./deploy/deploy.sh
